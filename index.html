<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>StoryBuilder | Grade 7</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React + ReactDOM UMD -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase (modular v11) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            onSnapshot,
            collection,
            addDoc
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Your existing Firebase project config :contentReference[oaicite:0]{index=0}
        const firebaseConfig = {
            apiKey: "AIzaSyCyIvXW4_5rxzZK2PkgyERjyelopk6ZGJo",
            authDomain: "choose-your-own-adventure-3464e.firebaseapp.com",
            projectId: "choose-your-own-adventure-3464e",
            storageBucket: "choose-your-own-adventure-3464e.appspot.com",
            messagingSenderId: "1078809830062",
            appId: "1:1078809830062:web:15b358b9385fb2931d0822"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        setPersistence(auth, browserLocalPersistence).catch(console.error);

        // Expose Firebase primitives to the React app
        window.firebase = {
            app,
            auth,
            db,
            signInAnonymously,
            onAuthStateChanged,
            doc,
            getDoc,
            setDoc,
            onSnapshot,
            collection,
            addDoc
        };
    </script>

    <style>
        body {
            @apply bg-slate-100;
        }
        .fade-in {
            animation: fade-in 0.2s ease-out;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-100">
<div id="root"></div>

<script type="text/babel" data-presets="react,env">
    const { useState, useEffect, useRef } = React;

    // ----- Initial Data -----
    const INITIAL_METADATA = {
        title: "Untitled Adventure",
        author: "",
        grade: "7",
        genre: "",
        summary: "Describe your choose-your-own adventure here."
    };

    const INITIAL_NODES = [
        {
            id: "start",
            title: "The Beginning",
            content: "Write the first scene of your adventure.",
            choices: [
                { id: "c1", text: "Add a choice in the Builder tab.", targetId: "" }
            ]
        }
    ];

    // ----- Small helper components -----
    const Tag = ({ children }) => (
        <span className="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100">
            {children}
        </span>
    );

    const TabButton = ({ active, children, onClick }) => (
        <button
            onClick={onClick}
            className={
                "px-4 py-2 text-sm font-semibold rounded-full transition-colors " +
                (active
                    ? "bg-indigo-600 text-white shadow-sm"
                    : "text-slate-600 hover:bg-slate-100")
            }
        >
            {children}
        </button>
    );

    // ----- Planner -----
    function Planner({ metadata, setMetadata, readOnly }) {
        const update = (field, value) => {
            if (readOnly) return;
            setMetadata(prev => ({ ...prev, [field]: value }));
        };

        return (
            <div className="grid md:grid-cols-2 gap-6 fade-in">
                <div className="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
                    <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        Story Plan <Tag>Section 1</Tag>
                    </h2>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-semibold text-slate-500 mb-1">
                                Title
                            </label>
                            <input
                                type="text"
                                value={metadata.title}
                                disabled={readOnly}
                                onChange={e => update("title", e.target.value)}
                                className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-semibold text-slate-500 mb-1">
                                    Author
                                </label>
                                <input
                                    type="text"
                                    value={metadata.author}
                                    disabled={readOnly}
                                    onChange={e => update("author", e.target.value)}
                                    className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-slate-500 mb-1">
                                    Genre
                                </label>
                                <input
                                    type="text"
                                    value={metadata.genre}
                                    disabled={readOnly}
                                    onChange={e => update("genre", e.target.value)}
                                    className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                />
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-semibold text-slate-500 mb-1">
                                Summary
                            </label>
                            <textarea
                                rows="4"
                                value={metadata.summary}
                                disabled={readOnly}
                                onChange={e => update("summary", e.target.value)}
                                className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                        </div>
                    </div>
                </div>
                <div className="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
                    <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        Teacher Checklist
                    </h2>
                    <ul className="space-y-2 text-sm text-slate-600">
                        <li>• Clear beginning, branching middle, and at least one ending.</li>
                        <li>• Every choice leads to another page or a conclusion.</li>
                        <li>• Second person (“you”) point of view.</li>
                        <li>• Correct punctuation and paragraphing for dialogue.</li>
                    </ul>
                </div>
            </div>
        );
    }

    // ----- Builder -----
    function Builder({ nodes, setNodes, activeNodeId, setActiveNodeId, readOnly }) {
        const activeNode = nodes.find(n => n.id === activeNodeId) || nodes[0];

        const updateNodeField = (field, value) => {
            if (readOnly) return;
            setNodes(prev =>
                prev.map(node =>
                    node.id === activeNode.id ? { ...node, [field]: value } : node
                )
            );
        };

        const updateChoice = (choiceId, field, value) => {
            if (readOnly) return;
            setNodes(prev =>
                prev.map(node =>
                    node.id === activeNode.id
                        ? {
                              ...node,
                              choices: node.choices.map(c =>
                                  c.id === choiceId ? { ...c, [field]: value } : c
                              )
                          }
                        : node
                )
            );
        };

        const addChoice = () => {
            if (readOnly) return;
            const newChoice = {
                id: "choice_" + Date.now(),
                text: "New choice",
                targetId: ""
            };
            setNodes(prev =>
                prev.map(node =>
                    node.id === activeNode.id
                        ? { ...node, choices: [...node.choices, newChoice] }
                        : node
                )
            );
        };

        const addNode = () => {
            if (readOnly) return;
            const newId = "node_" + Date.now();
            const newNode = {
                id: newId,
                title: "New Page",
                content: "Write the scene here.",
                choices: []
            };
            setNodes(prev => [...prev, newNode]);
            setActiveNodeId(newId);
        };

        return (
            <div className="grid md:grid-cols-[260px,1fr] gap-4 fade-in">
                {/* Sidebar list of pages */}
                <div className="bg-white rounded-xl shadow-sm p-4 border border-slate-200">
                    <div className="flex items-center justify-between mb-3">
                        <h3 className="text-sm font-bold text-slate-800">Pages</h3>
                        {!readOnly && (
                            <button
                                onClick={addNode}
                                className="text-xs font-semibold text-indigo-600 hover:underline"
                            >
                                + Add
                            </button>
                        )}
                    </div>
                    <div className="space-y-1 max-h-[420px] overflow-y-auto">
                        {nodes.map(node => (
                            <button
                                key={node.id}
                                onClick={() => setActiveNodeId(node.id)}
                                className={
                                    "w-full text-left px-3 py-2 rounded-lg text-sm border transition-colors " +
                                    (node.id === activeNode.id
                                        ? "bg-indigo-50 border-indigo-400 text-indigo-700 font-semibold"
                                        : "bg-slate-50 border-slate-200 text-slate-700 hover:bg-slate-100")
                                }
                            >
                                {node.title || "(Untitled Page)"}
                                {node.id === "start" && (
                                    <span className="ml-2 text-[10px] uppercase tracking-wide text-emerald-600">
                                        Start
                                    </span>
                                )}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Editor for current page */}
                <div className="bg-white rounded-xl shadow-sm p-6 border border-slate-200 flex flex-col gap-4">
                    <div className="flex items-center justify-between">
                        <input
                            type="text"
                            value={activeNode.title}
                            disabled={readOnly}
                            onChange={e => updateNodeField("title", e.target.value)}
                            className="text-lg font-bold text-slate-800 flex-1 border-0 border-b border-transparent focus:border-indigo-500 focus:ring-0 px-0"
                        />
                        <Tag>Page ID: {activeNode.id}</Tag>
                    </div>
                    <div>
                        <label className="block text-xs font-semibold text-slate-500 mb-1">
                            Page Text
                        </label>
                        <textarea
                            rows="8"
                            value={activeNode.content}
                            disabled={readOnly}
                            onChange={e => updateNodeField("content", e.target.value)}
                            className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                    </div>
                    <div>
                        <div className="flex items-center justify-between mb-1">
                            <span className="text-xs font-semibold text-slate-500">
                                Choices
                            </span>
                            {!readOnly && (
                                <button
                                    onClick={addChoice}
                                    className="text-xs font-semibold text-indigo-600 hover:underline"
                                >
                                    + Add Choice
                                </button>
                            )}
                        </div>
                        <div className="space-y-2">
                            {activeNode.choices.map(choice => (
                                <div
                                    key={choice.id}
                                    className="flex flex-col md:flex-row gap-2 items-stretch md:items-center bg-slate-50 border border-slate-200 rounded-lg p-2"
                                >
                                    <input
                                        type="text"
                                        value={choice.text}
                                        disabled={readOnly}
                                        onChange={e =>
                                            updateChoice(choice.id, "text", e.target.value)
                                        }
                                        className="flex-1 border border-slate-300 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        placeholder="Choice text"
                                    />
                                    <input
                                        type="text"
                                        value={choice.targetId}
                                        disabled={readOnly}
                                        onChange={e =>
                                            updateChoice(choice.id, "targetId", e.target.value)
                                        }
                                        className="w-32 border border-slate-300 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        placeholder="Target ID"
                                    />
                                </div>
                            ))}
                            {activeNode.choices.length === 0 && (
                                <p className="text-xs text-slate-500">
                                    No choices yet. Add at least one so the reader can continue.
                                </p>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // ----- Player (Preview) -----
    function Player({ nodes, metadata }) {
        const [currentId, setCurrentId] = useState("start");
        const [history, setHistory] = useState(["start"]);

        const currentNode = nodes.find(n => n.id === currentId) || nodes[0];

        const choose = targetId => {
            if (!targetId) return;
            setCurrentId(targetId);
            setHistory(prev => [...prev, targetId]);
        };

        const goBack = () => {
            if (history.length <= 1) return;
            const newHist = history.slice(0, -1);
            setHistory(newHist);
            setCurrentId(newHist[newHist.length - 1]);
        };

        const restart = () => {
            setCurrentId("start");
            setHistory(["start"]);
        };

        return (
            <div className="max-w-3xl mx-auto fade-in">
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="px-6 py-4 border-b border-slate-200">
                        <h2 className="text-xl font-bold text-slate-800">
                            {metadata.title || "Untitled Adventure"}
                        </h2>
                        <p className="text-xs text-slate-500 mt-1">
                            Click choices to move through the story.
                        </p>
                    </div>
                    <div className="px-6 py-6 space-y-6">
                        <h3 className="text-lg font-semibold text-slate-800">
                            {currentNode.title}
                        </h3>
                        <p className="text-slate-700 whitespace-pre-wrap leading-relaxed">
                            {currentNode.content}
                        </p>
                        <div className="space-y-2">
                            {currentNode.choices && currentNode.choices.length > 0 ? (
                                currentNode.choices.map(choice => (
                                    <button
                                        key={choice.id}
                                        disabled={!choice.targetId}
                                        onClick={() => choose(choice.targetId)}
                                        className={
                                            "w-full text-left px-4 py-3 rounded-lg text-sm border-2 transition-all " +
                                            (choice.targetId
                                                ? "border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 text-slate-700 hover:text-indigo-700"
                                                : "border-red-100 bg-red-50 text-red-400 cursor-not-allowed opacity-70")
                                        }
                                    >
                                        {choice.text}
                                    </button>
                                ))
                            ) : (
                                <div className="border border-slate-200 bg-slate-50 rounded-lg px-4 py-6 text-center text-sm text-slate-500">
                                    <p className="font-semibold mb-2">The End</p>
                                    <p className="mb-3">
                                        You reached a page with no choices.
                                    </p>
                                    <button
                                        onClick={restart}
                                        className="text-indigo-600 font-semibold hover:underline"
                                    >
                                        Play again from the beginning
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                    {history.length > 1 && (
                        <div className="px-6 py-3 border-t border-slate-200 flex justify-between text-xs text-slate-500">
                            <button
                                onClick={goBack}
                                className="hover:text-indigo-600 font-semibold"
                            >
                                ← Go back
                            </button>
                            <span>Pages visited: {history.length}</span>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    // ----- Main App -----
    function App() {
        const [firebaseUser, setFirebaseUser] = useState(null);
        const [authReady, setAuthReady] = useState(false);
        const [activeTab, setActiveTab] = useState("planner");
        const [metadata, setMetadata] = useState(INITIAL_METADATA);
        const [nodes, setNodes] = useState(INITIAL_NODES);
        const [activeNodeId, setActiveNodeId] = useState("start");
        const [isSyncing, setIsSyncing] = useState(false);
        const [isDataReady, setIsDataReady] = useState(false);
        const [toast, setToast] = useState(null);
        const [shareUrl, setShareUrl] = useState("");
        const [isShareOpen, setIsShareOpen] = useState(false);

        const saveTimeoutRef = useRef(null);
        const lastSavedRef = useRef(null);
        const urlParams = new URLSearchParams(window.location.search);
        const snapshotId = urlParams.get("snapshot");
        const isSnapshotMode = !!snapshotId;

        // Auth init
        useEffect(() => {
            if (!window.firebase) return;
            const { auth, signInAnonymously, onAuthStateChanged } = window.firebase;

            signInAnonymously(auth).catch(console.error);

            const unsub = onAuthStateChanged(auth, user => {
                setFirebaseUser(user);
                setAuthReady(true);
            });

            return () => unsub();
        }, []);

        // Load data: snapshot OR personal story
        useEffect(() => {
            if (!window.firebase || !window.firebase.db) return;
            const { db, doc, getDoc, onSnapshot, setDoc } = window.firebase;

            if (isSnapshotMode && snapshotId) {
                // Read-only shared snapshot
                (async () => {
                    try {
                        const ref = doc(db, "snapshots", snapshotId);
                        const snap = await getDoc(ref);
                        if (snap.exists()) {
                            const data = snap.data();
                            const loadedMeta = data.metadata || INITIAL_METADATA;
                            const loadedNodes = data.nodes || INITIAL_NODES;
                            setMetadata(loadedMeta);
                            setNodes(loadedNodes);
                            setActiveNodeId(loadedNodes[0]?.id || "start");
                            lastSavedRef.current = JSON.stringify({
                                metadata: loadedMeta,
                                nodes: loadedNodes
                            });
                        }
                    } catch (e) {
                        console.error("Snapshot load error", e);
                    } finally {
                        setIsDataReady(true);
                    }
                })();

                return;
            }

            // Editor mode: subscribe to user's doc
            if (!authReady || !firebaseUser) return;

            const storyRef = doc(db, "stories", firebaseUser.uid);

            const unsub = onSnapshot(
                storyRef,
                async snap => {
                    try {
                        if (snap.exists()) {
                            const data = snap.data();
                            const loadedMeta = data.metadata || INITIAL_METADATA;
                            const loadedNodes = data.nodes || INITIAL_NODES;
                            setMetadata(loadedMeta);
                            setNodes(loadedNodes);
                            setActiveNodeId(loadedNodes[0]?.id || "start");
                            lastSavedRef.current = JSON.stringify({
                                metadata: loadedMeta,
                                nodes: loadedNodes
                            });
                        } else {
                            await setDoc(storyRef, {
                                metadata: INITIAL_METADATA,
                                nodes: INITIAL_NODES,
                                lastUpdated: new Date().toISOString()
                            });
                            lastSavedRef.current = JSON.stringify({
                                metadata: INITIAL_METADATA,
                                nodes: INITIAL_NODES
                            });
                        }
                    } catch (e) {
                        console.error("Subscribe error", e);
                    } finally {
                        setIsDataReady(true);
                    }
                },
                error => {
                    console.error("onSnapshot error", error);
                    setIsDataReady(true);
                }
            );

            return () => unsub();
        }, [authReady, firebaseUser, isSnapshotMode, snapshotId]);

        // Autosave ONLY when data actually changed
        useEffect(() => {
            if (
                isSnapshotMode || // read-only
                !window.firebase ||
                !window.firebase.db ||
                !authReady ||
                !firebaseUser ||
                !isDataReady
            ) {
                return;
            }

            const current = JSON.stringify({ metadata, nodes });
            if (lastSavedRef.current === current) {
                // Nothing changed → don't show spinner or hit Firestore
                return;
            }

            if (saveTimeoutRef.current) {
                clearTimeout(saveTimeoutRef.current);
            }

            const { db, doc, setDoc } = window.firebase;

            saveTimeoutRef.current = setTimeout(async () => {
                try {
                    setIsSyncing(true);
                    const storyRef = doc(db, "stories", firebaseUser.uid);
                    await setDoc(storyRef, {
                        metadata,
                        nodes,
                        lastUpdated: new Date().toISOString()
                    });
                    lastSavedRef.current = current;
                } catch (e) {
                    console.error("Save error", e);
                } finally {
                    setIsSyncing(false);
                }
            }, 1000); // debounce

            return () => {
                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
            };
        }, [metadata, nodes, authReady, firebaseUser, isSnapshotMode, isDataReady]);

        const showToast = msg => {
            setToast(msg);
            setTimeout(() => setToast(null), 2500);
        };

        const handleShare = async () => {
            if (!window.firebase || !window.firebase.db) {
                showToast("Cloud not ready yet.");
                return;
            }
            const { db, collection, addDoc } = window.firebase;

            try {
                const colRef = collection(db, "snapshots");
                const docRef = await addDoc(colRef, {
                    metadata,
                    nodes,
                    ownerId: firebaseUser ? firebaseUser.uid : null,
                    createdAt: new Date().toISOString()
                });

                const base = window.location.href.split("?")[0];
                const url = `${base}?snapshot=${docRef.id}`;
                setShareUrl(url);
                setIsShareOpen(true);
                showToast("Share link created!");
            } catch (e) {
                console.error("Share error", e);
                showToast("Error creating share link.");
            }
        };

        const isReadOnly = isSnapshotMode;

        // ----- UI -----
        if (!isDataReady) {
            return (
                <div className="min-h-screen flex items-center justify-center">
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 px-8 py-6 text-center space-y-2">
                        <div className="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                        <p className="text-sm text-slate-700 font-semibold">
                            Connecting to your story…
                        </p>
                        <p className="text-xs text-slate-500">
                            Loading data from the cloud.
                        </p>
                    </div>
                </div>
            );
        }

        return (
            <div className="min-h-screen flex flex-col">
                {/* Header */}
                <header className="bg-white border-b border-slate-200 sticky top-0 z-40">
                    <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-lg bg-indigo-600 text-white flex items-center justify-center font-bold">
                                S
                            </div>
                            <div>
                                <div className="flex items-center gap-2">
                                    <h1 className="text-sm sm:text-base font-bold text-slate-800">
                                        StoryBuilder
                                    </h1>
                                    <span className="text-xs text-slate-400">
                                        | Grade 7 CYOA
                                    </span>
                                    {isSnapshotMode && (
                                        <span className="text-[10px] uppercase tracking-wide ml-2 px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100">
                                            Shared read-only
                                        </span>
                                    )}
                                </div>
                                <p className="text-[11px] text-slate-500">
                                    {firebaseUser
                                        ? isSnapshotMode
                                            ? "Viewing a shared snapshot."
                                            : "Working as guest (changes saved to this browser account)."
                                        : "Connecting…"}
                                </p>
                            </div>
                        </div>

                        <div className="flex items-center gap-4">
                            {!isSnapshotMode && (
                                <>
                                    {isSyncing && (
                                        <div className="flex items-center gap-1 text-xs text-slate-500">
                                            <div className="w-3 h-3 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin" />
                                            <span>Saving…</span>
                                        </div>
                                    )}
                                    <button
                                        onClick={handleShare}
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg text-xs sm:text-sm font-semibold flex items-center gap-2"
                                    >
                                        <span>Share</span>
                                    </button>
                                </>
                            )}
                            {isSnapshotMode && (
                                <button
                                    onClick={() =>
                                        (window.location.href =
                                            window.location.pathname)
                                    }
                                    className="text-xs text-slate-500 hover:text-indigo-600 font-semibold"
                                >
                                    Create your own
                                </button>
                            )}
                        </div>
                    </div>
                </header>

                {/* Tabs */}
                <main className="flex-1 max-w-6xl mx-auto w-full px-4 py-4 space-y-4">
                    <div className="flex items-center justify-between mb-2">
                        <div className="bg-slate-100 inline-flex p-1 rounded-full shadow-inner">
                            <TabButton
                                active={activeTab === "planner"}
                                onClick={() => setActiveTab("planner")}
                            >
                                Plan
                            </TabButton>
                            <TabButton
                                active={activeTab === "builder"}
                                onClick={() => setActiveTab("builder")}
                            >
                                Builder
                            </TabButton>
                            <TabButton
                                active={activeTab === "preview"}
                                onClick={() => setActiveTab("preview")}
                            >
                                Preview
                            </TabButton>
                        </div>
                    </div>

                    {activeTab === "planner" && (
                        <Planner
                            metadata={metadata}
                            setMetadata={setMetadata}
                            readOnly={isReadOnly}
                        />
                    )}
                    {activeTab === "builder" && (
                        <Builder
                            nodes={nodes}
                            setNodes={setNodes}
                            activeNodeId={activeNodeId}
                            setActiveNodeId={setActiveNodeId}
                            readOnly={isReadOnly}
                        />
                    )}
                    {activeTab === "preview" && (
                        <Player nodes={nodes} metadata={metadata} />
                    )}
                </main>

                {/* Toast */}
                {toast && (
                    <div className="fixed bottom-4 left-1/2 -translate-x-1/2">
                        <div className="bg-slate-900 text-white text-xs sm:text-sm px-4 py-2 rounded-full shadow-lg fade-in">
                            {toast}
                        </div>
                    </div>
                )}

                {/* Share modal */}
                {isShareOpen && (
                    <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
                        <div className="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 p-6 space-y-4 fade-in">
                            <div className="flex items-center justify-between">
                                <h3 className="text-lg font-bold text-indigo-700">
                                    Share Project
                                </h3>
                                <button
                                    onClick={() => setIsShareOpen(false)}
                                    className="text-slate-400 hover:text-slate-700 text-sm"
                                >
                                    ✕
                                </button>
                            </div>
                            <p className="text-sm text-slate-600">
                                Send this link so others can read your story and see
                                your structure.
                            </p>
                            <div className="flex border border-slate-300 rounded-lg overflow-hidden">
                                <input
                                    readOnly
                                    value={shareUrl}
                                    className="flex-1 px-3 py-2 text-xs sm:text-sm font-mono bg-white outline-none"
                                    onClick={e => e.target.select()}
                                />
                                <button
                                    onClick={() => {
                                        navigator.clipboard
                                            .writeText(shareUrl)
                                            .then(() =>
                                                showToast("Link copied to clipboard!")
                                            )
                                            .catch(() =>
                                                showToast(
                                                    "Copy failed – please copy manually."
                                                )
                                            );
                                    }}
                                    className="px-3 py-2 bg-indigo-600 text-white text-xs sm:text-sm font-semibold hover:bg-indigo-700"
                                >
                                    Copy
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
